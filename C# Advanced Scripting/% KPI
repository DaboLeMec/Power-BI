//For Percentage Measures
//Creates a folder for all the newly created measures and a subfolder for the conditional formatting measures
//Creates a measure for the most recent Month for every currently selected measure
//Creates a measure for the previous Month for the selected measure
//Creates a change measure between the most recent month and the previous month
//creates a measure for a target to compare to the most recent month
//creates conditional formatting for current vs target

//Loop through for each selected measure
foreach (var c in Selected.Measures)
{

var df = "__KPIs\\" + c.Name + "\\MoM";

// Prior month for the selected measure
    var PenultimateMeasure = c.Table.AddMeasure(
//Measure is called the selected measure name and "Penultimate"
    c.Name + " Penultimate",    
    "VAR M = MAX ( 'Date'[FirstDateofMonth] )"
    + "VAR Cal = CALCULATE (" + c.DaxObjectFullName
    + " ,FILTER (ALLSELECTED ( 'Date' ), 'Date'[FirstDateofMonth] = M - 1 )) "
    + "RETURN "
    + "Cal "
    );
// Set the format string on the new measure, percentage with one decimal place
    PenultimateMeasure.FormatString = "0.0%;-0.0%;0.0%";
//Set the display folder for the measure to be KPIS and subfolder of the measure name
    PenultimateMeasure.DisplayFolder = df;


//Most recent month for the measure
    var CurrentMeasure = c.Table.AddMeasure(
    c.Name + " Current",    // Currently Selected Measure Name Appended with Current
    "VAR M = MAX ( 'Date'[FirstDateofMonth] )"
    + "VAR Cal = CALCULATE (" + c.DaxObjectFullName
    + " ,FILTER (ALLSELECTED ( 'Date' ), 'Date'[FirstDateofMonth] = M )) "
    + "RETURN "
    + "Cal "
    );
// Set the format string on the new measure, percentage with one decimal place
    CurrentMeasure.FormatString = "0.0%;-0.0%;0.0%";
//Set the display folder for the measure to be KPIS and subfolder of the measure name
    CurrentMeasure.DisplayFolder = df;


//Create Measure of % Change between most recent month and prior month
    var PercentChangeMeasure = c.Table.AddMeasure(
//Selected measure name and "% Change" is the new measure name
         c.Name + " % Change",
//Cal is the current % Change
         "VAR Cal = " + CurrentMeasure.DaxObjectFullName + " - " + PenultimateMeasure.DaxObjectFullName
         + "RETURN "
         + "Cal"
        
    );
// Set the format string on the new measure, percentage with one decimal place
    PercentChangeMeasure.FormatString = "0.0%;-0.0%;0.0%";;
//Set the display folder for the measure to be KPIS and subfolder of the measure name
    PercentChangeMeasure.DisplayFolder = df;


//Create a measure that concatenates an Icon & Value for KPIs / Cards
    var PercentChangeIcon = c.Table.AddMeasure(
// Currently Selected Measure Name Appended with " KPI"
         c.Name + " KPI ",                    
         "VAR Down = UNICHAR( 10060 ) "
         + "VAR Up = UNICHAR( 9989 ) "
         + "VAR Side = UNICHAR( 11208 ) "
//Target is the penultimate value for the selected measure
         + "VAR Target = " + PenultimateMeasure.DaxObjectFullName
//Cal is the current value for the selected measure
         + "VAR Cal = " + CurrentMeasure.DaxObjectFullName
//Label for the Arrow is the % Change
         + "VAR Change = Cal - Target "
         + "RETURN "
//Switch Logic for each Arrow Scenario, Assumes up is good
         + "SWITCH( TRUE() ,"
         + "Cal "
         + "< Target, Down ,"
         + "Cal "
         + "= Target, Side ,"
         + "Cal "
         + " > Target, Up )"
//Format the KPI, properly escape quotes used in the measure
         + " & FORMAT( Change , \"0.0%;-0.0%;0.0%\" )"
    );
//Set the display folder for the measure to be KPIS and subfolder of the measure name
    PercentChangeIcon.DisplayFolder = df;

//Create Conditional Color Formatting for the KPI Comparing the two Months
    var PercentChangeArrowColors = c.Table.AddMeasure(
//Names is color and measure name and Conditional Formatting
         "Color " + c.Name + " Conditional Formatting",
         "VAR Down = \"#0a0a0aff\" "
         + "VAR Up =  \"#12239E\" "
         + "VAR Side = \"#f39c12\" "
//Target is 0 for up or down, can adjust as needed depending on requirement
         + "VAR Target = 0 "
//Cal is the current % Change
         + "VAR Cal = " + CurrentMeasure.DaxObjectFullName + " - " + PenultimateMeasure.DaxObjectFullName 
         + "RETURN "
//Switch Logic for each Arrow Scenario, Assumes up is good
         + "SWITCH( TRUE() ,"
         + "Cal "
         + "< Target, Down ,"
         + "Cal "
         + "= Target, Side ,"
         + "Cal "
         + " > Target, Up )"
        
    );
//Set the display folder for the measure to be KPIS, subfolder of the measure name, and conditional formatting to easily find it in the cf search box
    PercentChangeArrowColors.DisplayFolder = df + "\\Conditional Formatting";
    

//Create Conditional Icon Formatting for Tables / Matricies, uses default Power BI Icon Set
    var PercentChangeIcons = c.Table.AddMeasure(
         "Icon " + c.Name + " Conditional Formatting",
//Red X
         "VAR Down = \"SymbolLow\" "
//Green Checkmark
         + "VAR Up =  \"SymbolHigh\" "
//Yellow Exlamation Point
         + "VAR Side = \"SymbolMedium\" "
//Target is 0 for up or down, can adjust as needed depending on requirement
         + "VAR Target = 0 "
//Cal is the current % Change
         + "VAR Cal = DIVIDE( " + CurrentMeasure.DaxObjectFullName + " - " + PenultimateMeasure.DaxObjectFullName + " , " + PenultimateMeasure.DaxObjectFullName + " , 0 ) "
         + "RETURN "
//Switch Logic for each Arrow Scenario, Assumes up is good
         + "SWITCH( TRUE() ,"
         + "Cal "
         + "< Target, Down ,"
         + "Cal "
         + "= Target, Side ,"
         + "Cal "
         + " > Target, Up )"
        
    );
//Set the display folder for the measure to be KPIS, subfolder of the measure name, and conditional formatting to easily find it in the cf search box
    PercentChangeIcons.DisplayFolder = df + "\\Conditional Formatting";

//Adding additional KPIs/Formatting for comparing Targets in addition to Month Over Month

//Variable for Folder Name for Targets
var TDF = "__KPIs\\" + c.Name + "\\Target";

//Create Measure For the Target to compare to
    var TargetMeasure = c.Table.AddMeasure(
//Selected measure name and " Target" is the new measure name
         c.Name + " Target",
//Target is the target amt, hardcoded to 0 initially
         "VAR Target = " + "0"
         + "RETURN "
         + "Target"
        
    );
//Set the Measure Folder Location
 TargetMeasure.DisplayFolder = TDF;

//Create Measure of % Change between most recent month and a target
    var currentvstarget = c.Table.AddMeasure(
//Selected measure name current vs target is the new measure name
         c.Name + " Current vs Target",
//Cal is the current % Change
         "VAR Cal = " + CurrentMeasure.DaxObjectFullName + " - " + TargetMeasure.DaxObjectFullName
         + "RETURN "
         + "Cal"
        
    );
//Set the display folder for the measure to be KPIS, subfolder of the measure name, and conditional formatting to easily find it in the cf search box
    currentvstarget.DisplayFolder = TDF;

//Create Conditional Color Formatting for the KPI Comparing the two Months
    var PercentChangeTargetArrowColors = c.Table.AddMeasure(
//Names is color and measure name and Conditional Formatting
         "Target Color " + c.Name + " Conditional Formatting",
         "VAR Down = \"#0a0a0aff\" "
         + "VAR Up =  \"#12239E\" "
         + "VAR Side = \"#f39c12\" "
//Set to the target measure
         + "VAR Target =" + TargetMeasure.DaxObjectFullName
//Cal is the current % Change, reference newly created target comp measure
         + "VAR Cal = " + currentvstarget.DaxObjectFullName
         + "RETURN "
//Switch Logic for each Arrow Scenario, Assumes up is good
         + "SWITCH( TRUE() ,"
         + "Cal "
         + "< Target, Down ,"
         + "Cal "
         + "= Target, Side ,"
         + "Cal "
         + " > Target, Up )"
        
    );
//Set the display folder for the measure to be KPIS, subfolder of the measure name, and conditional formatting to easily find it in the cf search box
    PercentChangeTargetArrowColors.DisplayFolder = TDF + "\\Conditional Formatting";
    
    
//Create Conditional Icon Formatting for Tables / Matricies, uses default Power BI Icon Set
    var PercentChangeTargetIcons = c.Table.AddMeasure(
         "Target Icon " + c.Name + " Conditional Formatting",
//Red X
         "VAR Down = \"SymbolLow\" "
//Green Checkmark
         + "VAR Up =  \"SymbolHigh\" "
//Yellow Exlamation Point
         + "VAR Side = \"SymbolMedium\" "
//Target is 0 for up or down, can adjust as needed depending on requirement
         + "VAR Target = 0 "
//Cal is the current % Change
         + "VAR Cal = " + currentvstarget.DaxObjectFullName
         + "RETURN "
//Switch Logic for each Arrow Scenario, Assumes up is good
         + "SWITCH( TRUE() ,"
         + "Cal "
         + "< Target, Down ,"
         + "Cal "
         + "= Target, Side ,"
         + "Cal "
         + " > Target, Up )"
        
    );
//Set the display folder for the measure to be KPIS, subfolder of the measure name, and conditional formatting to easily find it in the cf search box
    PercentChangeTargetIcons.DisplayFolder = TDF + "\\Conditional Formatting";

}
